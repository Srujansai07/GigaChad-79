// Prisma schema for BroGigaChad
// Database: Neon PostgreSQL with Prisma Accelerate

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // For migrations
}

// ==========================================
// USER MODEL
// ==========================================
model User {
  id                String   @id @default(cuid())
  email             String   @unique
  username          String   @unique
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Stats
  aura              Int      @default(0)
  level             Int      @default(1)
  streak            Int      @default(0)
  lastActiveAt      DateTime @default(now())
  tasksCompleted    Int      @default(0)
  strictModeCount   Int      @default(0)
  
  // Preferences
  notificationsEnabled Boolean @default(true)
  strictModeEnabled    Boolean @default(true)
  
  // Relations
  tasks             Task[]
  auraHistory       AuraEvent[]
  badges            UserBadge[]
  challenges        ChallengeParticipant[]
  posts             Post[]
  likes             Like[]
  comments          Comment[]
  
  @@index([username])
  @@index([aura])
}

// ==========================================
// TASK MODEL
// ==========================================
model Task {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title         String
  description   String?
  app           String    // Target app for deep linking
  baseAura      Int       @default(100)
  
  // Status
  status        TaskStatus @default(PENDING)
  completed     Boolean    @default(false)
  completedAt   DateTime?
  auraGained    Int?
  
  // Scheduling
  scheduledFor  DateTime
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  // Skip tracking
  skipCount     Int        @default(0)
  lastSkippedAt DateTime?
  
  // Strict mode trigger
  strictModeTriggered Boolean @default(false)
  
  @@index([userId])
  @@index([scheduledFor])
  @@index([status])
}

enum TaskStatus {
  PENDING
  NOTIFIED
  SKIPPED
  STRICT_MODE
  COMPLETED
  CANCELLED
}

// ==========================================
// AURA EVENT MODEL (History tracking)
// ==========================================
model AuraEvent {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  amount    Int      // Positive for gain, negative for loss
  reason    AuraReason
  taskId    String?  // Optional task reference
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

enum AuraReason {
  TASK_COMPLETE
  FIRST_NOTIFICATION_BONUS
  STREAK_BONUS
  STRICT_MODE_BONUS
  SKIP_PENALTY
  CANCEL_PENALTY
  BADGE_REWARD
  CHALLENGE_WIN
  DAILY_BONUS
}

// ==========================================
// BADGE SYSTEM
// ==========================================
model Badge {
  id          String      @id @default(cuid())
  name        String      @unique
  description String
  emoji       String
  auraReward  Int         @default(0)
  
  // Unlock criteria
  criteria    Json        // Flexible criteria like {tasksCompleted: 10} or {streak: 7}
  
  users       UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId   String
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  unlockedAt DateTime @default(now())
  
  @@unique([userId, badgeId])
}

// ==========================================
// NOTIFICATION TRACKING
// ==========================================
model NotificationLog {
  id        String   @id @default(cuid())
  userId    String
  taskId    String
  
  type      NotificationType
  sentAt    DateTime @default(now())
  
  // Track user response
  actionTaken NotificationAction?
  respondedAt DateTime?
  
  @@index([userId])
  @@index([taskId])
}

enum NotificationType {
  FIRST_REMINDER
  SECOND_REMINDER
  FINAL_WARNING
  STRICT_MODE_ACTIVATION
}

enum NotificationAction {
  DO_IT
  EXTEND_10
  EXTEND_30
  IGNORED
}

// ==========================================
// SQUADS & SOCIAL
// ==========================================
model Squad {
  id          String        @id @default(cuid())
  name        String
  code        String        @unique // Join code
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Stats
  totalAura   Int           @default(0)
  weeklyGoal  Int           @default(100)
  
  members     SquadMember[]
  
  @@index([code])
}

model SquadMember {
  id        String    @id @default(cuid())
  squadId   String
  squad     Squad     @relation(fields: [squadId], references: [id], onDelete: Cascade)
  userId    String
  role      SquadRole @default(MEMBER)
  joinedAt  DateTime  @default(now())
  
  // Contribution
  weeklyAura Int      @default(0)
  
  @@unique([squadId, userId])
  @@index([userId])
}

enum SquadRole {
  LEADER
  MEMBER
}

// ==========================================
// CHALLENGES
// ==========================================
model Challenge {
  id          String        @id @default(cuid())
  name        String
  description String
  type        ChallengeType
  
  // Goals
  goal        Int
  reward      Int           @default(500)
  
  // Timing
  startsAt    DateTime
  endsAt      DateTime
  createdAt   DateTime      @default(now())
  
  // Status
  active      Boolean       @default(true)
  
  @@index([type])
  @@index([active])

  participants ChallengeParticipant[]
}

model ChallengeParticipant {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  challengeId String
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  
  progress    Int       @default(0)
  completed   Boolean   @default(false)
  joinedAt    DateTime  @default(now())
  completedAt DateTime?
  
  @@unique([userId, challengeId])
  @@index([challengeId])
}

enum ChallengeType {
  SOLO
  PVP
  SQUAD
}

// ==========================================
// HABITS
// ==========================================
model Habit {
  id              String      @id @default(cuid())
  userId          String
  name            String
  frequency       HabitFrequency @default(DAILY)
  
  // Stats
  streak          Int         @default(0)
  bestStreak      Int         @default(0)
  completedToday  Boolean     @default(false)
  lastCompletedAt DateTime?
  
  // Rewards
  auraPerComplete Int         @default(50)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([userId])
}

enum HabitFrequency {
  DAILY
  WEEKLY
}

// ==========================================
// GOALS
// ==========================================
model Goal {
  id          String    @id @default(cuid())
  userId      String
  title       String
  
  // Progress
  target      Int
  current     Int       @default(0)
  unit        String    // "tasks", "days", "aura"
  
  // Timing
  deadline    DateTime?
  completedAt DateTime?
  
  // Rewards
  auraReward  Int       @default(500)
  completed   Boolean   @default(false)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([userId])
  @@index([completed])
}

// ==========================================
// SHOP & INVENTORY
// ==========================================
model ShopItem {
  id          String    @id @default(cuid())
  name        String
  description String
  cost        Int
  type        ItemType
  emoji       String?
  
  // Metadata for effects
  effect      Json?     // e.g. { "duration": 24, "multiplier": 2 }
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  users       UserItem[]
}

model UserItem {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  itemId      String
  item        ShopItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  quantity    Int       @default(1)
  acquiredAt  DateTime  @default(now())
  
  @@unique([userId, itemId])
  @@index([userId])
}

enum ItemType {
  POWERUP
  COSMETIC
  THEME
  BADGE
}

// ==========================================
// SOCIAL FEED
// ==========================================
model Post {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content   String
  imageUrl  String?
  type      PostType  @default(FLEX)
  
  // Stats
  likes     Like[]
  comments  Comment[]
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@index([userId])
  @@index([createdAt])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, postId])
  @@index([postId])
}

model Comment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  content   String
  createdAt DateTime @default(now())
  
  @@index([postId])
}

enum PostType {
  FLEX
  ACHIEVEMENT
  UPDATE
}
